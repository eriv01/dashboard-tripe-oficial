<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard TRIPE - Analytics v9.7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: #e5e7eb; }
        .glass { background: rgba(17, 17, 17, 0.8 ); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .card-stat { transition: transform 0.2s; }
        .card-stat:hover { transform: translateY(-4px); }
        .variant-row:nth-child(even) { background: rgba(255, 255, 255, 0.02); }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-800 tracking-tighter text-white">MÉTODO <span class="text-red-500">TRIPE</span></h1>
                <p class="text-gray-500 text-sm">Analytics em Tempo Real • v9.7</p>
            </div>
            <div id="connection-status" class="px-4 py-2 rounded-full bg-green-500/10 border border-green-500/20 text-green-500 text-xs font-bold flex items-center gap-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> CONECTADO AO FIREBASE
            </div>
        </div>

        <!-- Resumo Geral -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="glass p-6 rounded-3xl card-stat">
                <p class="text-gray-400 text-xs font-bold uppercase mb-1">Total de Leads</p>
                <h2 id="total-leads" class="text-4xl font-800 text-white">0</h2>
            </div>
            <div class="glass p-6 rounded-3xl card-stat border-l-4 border-yellow-500">
                <p class="text-gray-400 text-xs font-bold uppercase mb-1">Gerados (Pix/Bol)</p>
                <h2 id="total-generated" class="text-4xl font-800 text-yellow-500">0</h2>
            </div>
            <div class="glass p-6 rounded-3xl card-stat border-l-4 border-green-500">
                <p class="text-gray-400 text-xs font-bold uppercase mb-1">Vendas Aprovadas</p>
                <h2 id="total-sales" class="text-4xl font-800 text-green-500">0</h2>
            </div>
            <div class="glass p-6 rounded-3xl card-stat">
                <p class="text-gray-400 text-xs font-bold uppercase mb-1">Faturamento Total</p>
                <h2 id="total-revenue" class="text-4xl font-800 text-white">R$ 0,00</h2>
            </div>
        </div>

        <!-- Tabela de Variantes A/B -->
        <div class="glass rounded-3xl overflow-hidden mb-8">
            <div class="p-6 border-b border-white/5 flex justify-between items-center">
                <h3 class="font-800 text-xl text-white">Performance por Variante (A/B Test)</h3>
                <span class="text-xs text-gray-500 uppercase font-bold">Atualização Automática</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-gray-400 text-xs uppercase font-bold border-b border-white/5">
                            <th class="p-6">Variante</th>
                            <th class="p-6">Leads</th>
                            <th class="p-6">Gerados</th>
                            <th class="p-6">Vendas</th>
                            <th class="p-6">Conversão</th>
                            <th class="p-6">Faturamento</th>
                        </tr>
                    </thead>
                    <tbody id="variants-table-body">
                        <!-- Injetado via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Log de Atividade Recente -->
        <div class="glass rounded-3xl p-6">
            <h3 class="font-800 text-xl text-white mb-4">Últimos Eventos</h3>
            <div id="event-log" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                <!-- Injetado via JS -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCDYmSVU2xVVuLw0vu3svKI7n4hvdxjW0w",
            authDomain: "projeto-tripe-oficial.firebaseapp.com",
            databaseURL: "https://projeto-tripe-oficial-default-rtdb.firebaseio.com",
            projectId: "projeto-tripe-oficial",
            storageBucket: "projeto-tripe-oficial.firebasestorage.app",
            messagingSenderId: "274742031259",
            appId: "1:274742031259:web:18dc5c086fe3d58b56673e"
        };

        const app = initializeApp(firebaseConfig );
        const db = getDatabase(app);

        // Referências
        const statsRef = ref(db, 'ab_testing/variants');
        const sessionsRef = ref(db, 'sessions');

        // Escuta as Variantes
        onValue(statsRef, (snapshot) => {
            const data = snapshot.val();
            const tableBody = document.getElementById('variants-table-body');
            tableBody.innerHTML = '';

            let totalL = 0, totalG = 0, totalS = 0, totalR = 0;

            if (data) {
                Object.keys(data).sort().forEach(key => {
                    const v = data[key];
                    const leads = v.total_leads || 0;
                    const generated = v.generated || 0;
                    const sales = v.sales || 0;
                    const revenue = v.revenue || 0;
                    const conv = leads > 0 ? ((sales / leads) * 100).toFixed(1) : 0;

                    totalL += leads; totalG += generated; totalS += sales; totalR += revenue;

                    tableBody.innerHTML += `
                        <tr class="variant-row border-b border-white/5 hover:bg-white/5 transition-colors">
                            <td class="p-6 font-bold text-white">${key.replace('_', ' ')}</td>
                            <td class="p-6 text-gray-300">${leads}</td>
                            <td class="p-6 text-yellow-500 font-bold">${generated}</td>
                            <td class="p-6 text-green-500 font-bold">${sales}</td>
                            <td class="p-6"><span class="bg-red-500/10 text-red-500 px-2 py-1 rounded text-xs font-bold">${conv}%</span></td>
                            <td class="p-6 text-white font-bold">R$ ${revenue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        </tr>
                    `;
                });
            }

            document.getElementById('total-leads').innerText = totalL;
            document.getElementById('total-generated').innerText = totalG;
            document.getElementById('total-sales').innerText = totalS;
            document.getElementById('total-revenue').innerText = `R$ ${totalR.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        });

        // Escuta as Sessões para o Log
        onValue(sessionsRef, (snapshot) => {
            const data = snapshot.val();
            const log = document.getElementById('event-log');
            log.innerHTML = '';

            if (data) {
                const recent = Object.keys(data).map(k => ({id: k, ...data[k]}))
                    .sort((a, b) => (b.lastUpdate || 0) - (a.lastUpdate || 0))
                    .slice(0, 15);

                recent.forEach(s => {
                    let statusColor = "text-gray-500";
                    let statusText = s.status || "active";
                    
                    if(statusText === 'paid') { statusColor = "text-green-500 font-bold"; statusText = "VENDA APROVADA"; }
                    if(statusText === 'waiting_payment') { statusColor = "text-yellow-500 font-bold"; statusText = "PIX/BOL GERADO"; }
                    if(statusText === 'checkout_clicked') { statusColor = "text-blue-400"; statusText = "CLICOU NO CHECKOUT"; }

                    log.innerHTML += `
                        <div class="flex justify-between items-center p-3 rounded-xl bg-white/5 border border-white/5">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-gray-500 font-mono">${s.id}</span>
                                <span class="text-xs font-bold ${statusColor}">${statusText}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] block text-gray-500">VARIANTE: ${s.variantIdx !== undefined ? String.fromCharCode(65 + s.variantIdx) : '?'}</span>
                                <span class="text-[10px] text-gray-600">${s.lastUpdate ? new Date(s.lastUpdate).toLocaleTimeString() : ''}</span>
                            </div>
                        </div>
                    `;
                });
            }
        });
    </script>
</body>
</html>
