<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelig√™ncia TRIPE - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #ef4444; --bg: #0a0a0a; --card: #141414; --border: #262626; }
        body { font-family: 'Inter', sans-serif; background: var(--bg ); color: white; padding: 20px; margin: 0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 15px; }
        .stat-val { font-size: 32px; font-weight: 800; color: var(--primary); margin: 10px 0; }
        .winner-badge { background: rgba(239, 68, 68, 0.1); color: var(--primary); padding: 10px; border-radius: 8px; border: 1px solid var(--primary); margin-top: 10px; display: inline-block; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .chart-container { height: 300px; position: relative; }
    </style>
</head>
<body>
    <div style="max-width: 1200px; margin: 0 auto;">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1>üöÄ Intelig√™ncia de Convers√£o</h1>
            <div id="status">Conectado ao Firebase</div>
        </header>

        <div class="grid">
            <div class="card">
                <h3>Sess√µes Totais</h3>
                <div class="stat-val" id="totalSessions">0</div>
                <p>√öltimos 7 dias</p>
            </div>
            <div class="card">
                <h3>Convers√£o M√©dia</h3>
                <div class="stat-val" id="avgConv">0%</div>
                <p>Meta: 100%</p>
            </div>
            <div class="card">
                <h3>Varia√ß√£o Campe√£</h3>
                <div id="winnerInfo" class="winner-badge">Analisando dados...</div>
                <button onclick="window.fixWinner()" style="margin-top: 10px;">FIXAR CAMPE√É</button>
            </div>
        </div>

        <div class="grid">
            <div class="card" style="grid-column: span 2;">
                <h3>Cliques por Hora (Hoje)</h3>
                <div class="chart-container"><canvas id="hourChart"></canvas></div>
            </div>
            <div class="card">
                <h3>Performance por Variante</h3>
                <table id="variantTable">
                    <thead><tr><th>Variante</th><th>Testes</th><th>Conv.</th><th>%</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3>üî¥ Atividade em Tempo Real</h3>
            <div id="liveFeed" style="max-height: 300px; overflow-y: auto; margin-top: 15px;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, set, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCDYmSVU2xVVuLw0vu3svKI7n4hvdxjW0w",
            authDomain: "projeto-tripe-oficial.firebaseapp.com",
            databaseURL: "https://projeto-tripe-oficial-default-rtdb.firebaseio.com",
            projectId: "projeto-tripe-oficial",
            storageBucket: "projeto-tripe-oficial.firebasestorage.app",
            messagingSenderId: "274742031259",
            appId: "1:274742031259:web:18dc5c086fe3d58b56673e"
        };

        const app = initializeApp(firebaseConfig );
        const db = getDatabase(app);
        let hourChart;

        const ctx = document.getElementById('hourChart').getContext('2d');
        hourChart = new Chart(ctx, {
            type: 'line',
            data: { labels: Array.from({length: 24}, (_, i) => i+'h'), datasets: [{ label: 'Cliques', data: new Array(24).fill(0), borderColor: '#ef4444', tension: 0.4 }] },
            options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#262626' } }, x: { grid: { display: false } } } }
        });

        onValue(ref(db, '/'), (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            const sessions = data.sessions ? Object.values(data.sessions) : [];
            document.getElementById('totalSessions').textContent = sessions.length;
            
            const conversions = sessions.filter(s => s.currentStep === 99).length;
            document.getElementById('avgConv').textContent = (sessions.length > 0 ? (conversions/sessions.length*100).toFixed(1) : 0) + '%';

            const hourData = new Array(24).fill(0);
            sessions.forEach(s => {
                if (s.enteredAt) {
                    const hour = new Date(s.enteredAt).getHours();
                    hourData[hour]++;
                }
            });
            hourChart.data.datasets[0].data = hourData;
            hourChart.update();

            const variants = data.optimization ? data.optimization.variants : {};
            let bestVar = { id: null, rate: -1 };
            let tableHtml = '';
            
            Object.keys(variants).forEach(key => {
                const v = variants[key];
                const rate = v.tests > 0 ? (v.converted / v.tests * 100).toFixed(1) : 0;
                if (parseFloat(rate) > bestVar.rate) bestVar = { id: key, rate: parseFloat(rate) };
                tableHtml += '<tr><td>' + key + '</td><td>' + (v.tests || 0) + '</td><td>' + (v.converted || 0) + '</td><td>' + rate + '%</td></tr>';
            });
            document.getElementById('variantTable').querySelector('tbody').innerHTML = tableHtml;
            if (bestVar.id) document.getElementById('winnerInfo').textContent = 'Campe√£: ' + bestVar.id + ' (' + bestVar.rate + '%)';

            const live = sessions.slice(-10).reverse();
            document.getElementById('liveFeed').innerHTML = live.map(s => `
                <div style="padding: 10px; border-bottom: 1px solid #262626; font-size: 13px;">
                    <span style="color: #ef4444">‚óè</span> Usu√°rio em <strong>${s.stepName || 'In√≠cio'}</strong> 
                    <small style="color: #9ca3af; float: right;">${new Date(s.lastUpdate || s.enteredAt).toLocaleTimeString()}</small>
                </div>
            `).join('');
        });

        window.fixWinner = async () => {
            const snap = await get(ref(db, 'optimization/variants'));
            if (!snap.exists()) return;
            const variants = snap.val();
            let bestIdx = 0;
            let bestRate = -1;
            
            [0,1,2,3,4].forEach(i => {
                const v = variants['cta_' + i] || {tests: 0, converted: 0};
                const rate = v.tests > 0 ? v.converted / v.tests : 0;
                if (rate > bestRate) { bestRate = rate; bestIdx = i; }
            });

            await set(ref(db, 'optimization/winner'), { saudacao: bestIdx, resultado: bestIdx, cta: bestIdx });
            alert("Varia√ß√£o " + bestIdx + " fixada como campe√£ para todos os usu√°rios!");
        };
    </script>
</body>
</html>
