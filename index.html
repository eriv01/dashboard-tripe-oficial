<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelig√™ncia TRIPE - Dashboard Ultra v7</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #ef4444; --bg: #0a0a0a; --card: #141414; --border: #262626; --text: #ffffff; --muted: #9ca3af; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg ); color: var(--text); padding: 20px; line-height: 1.5; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .status-tag { background: rgba(16, 185, 129, 0.1); color: #10b981; padding: 5px 12px; border-radius: 50px; font-size: 12px; font-weight: 800; border: 1px solid #10b981; }
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card); border: 1px solid var(--border); padding: 25px; border-radius: 20px; position: relative; overflow: hidden; }
        .card h3 { font-size: 13px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .stat-val { font-size: 36px; font-weight: 800; color: var(--primary); }
        .grid-main { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        @media (max-width: 900px) { .grid-main { grid-template-columns: 1fr; } }
        .accordion { margin-bottom: 10px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
        .accordion-header { background: var(--card); padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 700; transition: 0.3s; }
        .accordion-header:hover { background: #1a1a1a; }
        .accordion-content { background: #0d0d0d; padding: 0; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s; }
        .accordion.active .accordion-content { max-height: 1000px; padding: 20px; }
        .chart-box { height: 300px; width: 100%; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; color: var(--muted); font-size: 11px; text-transform: uppercase; padding: 10px; border-bottom: 1px solid var(--border); }
        td { padding: 12px 10px; border-bottom: 1px solid var(--border); font-size: 14px; font-weight: 600; }
        .live-feed { max-height: 400px; overflow-y: auto; }
        .feed-item { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .dot { height: 8px; width: 8px; background: var(--primary); border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 10px var(--primary); }
        .btn-fix { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 800; cursor: pointer; width: 100%; margin-top: 15px; transition: 0.2s; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div><h1>üöÄ Intelig√™ncia TRIPE v7</h1><p style="color: var(--muted); font-size: 14px;">An√°lise de Fric√ß√£o e Otimiza√ß√£o de Copy</p></div>
            <div class="status-tag">LIVE: MONITORANDO</div>
        </header>
        <div class="grid-stats">
            <div class="card"><h3>Visitas (Hoje)</h3><div class="stat-val" id="todayVisits">0</div></div>
            <div class="card"><h3>Checkouts (Hoje)</h3><div class="stat-val" id="todaySales">0</div></div>
            <div class="card"><h3>Convers√£o Geral</h3><div class="stat-val" id="convRate">0%</div></div>
            <div class="card"><h3>Online Agora</h3><div class="stat-val" id="onlineNow">0</div></div>
        </div>
        <div class="grid-main">
            <div class="card"><h3>üìà Fluxo de Acessos (24h)</h3><div class="chart-box"><canvas id="hourChart"></canvas></div></div>
            <div class="card"><h3>üèÜ Variante Campe√£</h3><div id="winnerBadge" style="font-size: 18px; font-weight: 800; color: var(--primary); margin: 15px 0;">Analisando...</div><button class="btn-fix" onclick="window.fixWinner()">FIXAR VENCEDORA</button></div>
        </div>
        <div class="grid-main">
            <div class="card"><h3>üìä Funil de Fuga (Drop-off)</h3><div class="chart-box"><canvas id="funnelChart"></canvas></div></div>
            <div class="card"><h3>‚è±Ô∏è √çndice de Fric√ß√£o (Tempo de Resposta)</h3><div class="chart-box"><canvas id="frictionChart"></canvas></div><p style="color: var(--muted); font-size: 11px; margin-top: 10px;">Tempo m√©dio em segundos por pergunta. Menos √© melhor.</p></div>
        </div>
        <div class="grid-main">
            <div class="card"><h3>üìÇ Hist√≥rico 7 Dias</h3><div id="historyAccordion"></div></div>
            <div class="card"><h3>üî¥ Atividade Real</h3><div class="live-feed" id="liveFeed"></div></div>
        </div>
        <div class="card" style="margin-top: 30px;">
            <h3>üß™ Performance Detalhada das Variantes</h3>
            <table id="variantTable"><thead><tr><th>√Çngulo de Copy</th><th>Testes</th><th>Checkouts</th><th>Convers√£o</th></tr></thead><tbody></tbody></table>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, set, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        const firebaseConfig = {
            apiKey: "AIzaSyCDYmSVU2xVVuLw0vu3svKI7n4hvdxjW0w",
            authDomain: "projeto-tripe-oficial.firebaseapp.com",
            databaseURL: "https://projeto-tripe-oficial-default-rtdb.firebaseio.com",
            projectId: "projeto-tripe-oficial",
            storageBucket: "projeto-tripe-oficial.firebasestorage.app",
            messagingSenderId: "274742031259",
            appId: "1:274742031259:web:18dc5c086fe3d58b56673e"
        };
        const app = initializeApp(firebaseConfig );
        const db = getDatabase(app);
        let hourChart, funnelChart, frictionChart;

        function initCharts() {
            const ctxH = document.getElementById('hourChart').getContext('2d');
            hourChart = new Chart(ctxH, { type: 'line', data: { labels: Array.from({length: 24}, (_, i) => i+'h'), datasets: [{ label: 'Acessos', data: new Array(24).fill(0), borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.4 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#262626' } }, x: { grid: { display: false } } } } });
            const ctxF = document.getElementById('funnelChart').getContext('2d');
            funnelChart = new Chart(ctxF, { type: 'bar', data: { labels: ['In√≠cio', 'P1', 'P2', 'P3', 'P4', 'P5', 'P6', 'P7', 'Checkout'], datasets: [{ label: '% Avan√ßo', data: new Array(9).fill(0), backgroundColor: '#ef4444', borderRadius: 5 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { max: 100, beginAtZero: true, grid: { color: '#262626' } }, x: { grid: { display: false } } } } });
            const ctxFr = document.getElementById('frictionChart').getContext('2d');
            frictionChart = new Chart(ctxFr, { type: 'bar', data: { labels: ['P1', 'P2', 'P3', 'P4', 'P5', 'P6', 'P7'], datasets: [{ label: 'Segundos', data: new Array(7).fill(0), backgroundColor: '#3b82f6', borderRadius: 5 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#262626' } }, x: { grid: { display: false } } } } });
        }

        onValue(ref(db, '/'), (snapshot) => {
            const data = snapshot.val(); if (!data) return;
            const sessions = data.sessions ? Object.values(data.sessions) : [];
            const now = Date.now(); const today = new Date().setHours(0,0,0,0);
            const todaySessions = sessions.filter(s => (s.enteredAt || 0) >= today);
            const todaySales = todaySessions.filter(s => s.currentStep === 99).length;
            document.getElementById('todayVisits').textContent = todaySessions.length;
            document.getElementById('todaySales').textContent = todaySales;
            document.getElementById('convRate').textContent = (todaySessions.length > 0 ? (todaySales/todaySessions.length*100).toFixed(1) : 0) + '%';
            const online = sessions.filter(s => (s.lastUpdate || s.enteredAt) > now - 300000).length;
            document.getElementById('onlineNow').textContent = online;
            const hourData = new Array(24).fill(0);
            todaySessions.forEach(s => { const h = new Date(s.enteredAt).getHours(); hourData[h]++; });
            hourChart.data.datasets[0].data = hourData; hourChart.update();
            const funnelCounts = new Array(10).fill(0);
            sessions.forEach(s => { const step = s.currentStep === 99 ? 9 : (s.currentStep || 0); for(let i=0; i<=step; i++) if(i < 10) funnelCounts[i]++; });
            const funnelPerc = funnelCounts.map((count, i) => { if (i === 0) return 100; return funnelCounts[i-1] > 0 ? (count / funnelCounts[i-1] * 100).toFixed(1) : 0; }).slice(1);
            funnelChart.data.datasets[0].data = [100, ...funnelPerc]; funnelChart.update();
            
            if (data.optimization && data.optimization.metrics && data.optimization.metrics.hesitation) {
                const hes = data.optimization.metrics.hesitation;
                const avgFriction = new Array(7).fill(0);
                for(let i=1; i<=7; i++) {
                    let total = 0, count = 0;
                    [0,1,2,3,4].forEach(v => {
                        if(hes['v'+v] && hes['v'+v]['step'+i]) {
                            total += hes['v'+v]['step'+i].totalTime;
                            count += hes['v'+v]['step'+i].count;
                        }
                    });
                    avgFriction[i-1] = count > 0 ? (total / count / 1000).toFixed(1) : 0;
                }
                frictionChart.data.datasets[0].data = avgFriction;
                frictionChart.update();
            }

            const variants = data.optimization ? data.optimization.variants : {};
            let best = { id: 'Nenhuma', rate: -1 }; let tableHtml = '';
            Object.keys(variants).forEach(key => {
                const v = variants[key]; const rate = v.tests > 0 ? (v.converted / v.tests * 100).toFixed(1) : 0;
                if (parseFloat(rate) > best.rate) best = { id: key, rate: parseFloat(rate) };
                tableHtml += '<tr><td>' + key + '</td><td>' + (v.tests || 0) + '</td><td>' + (v.converted || 0) + '</td><td style="color: var(--primary)">' + rate + '%</td></tr>';
            });
            document.getElementById('variantTable').querySelector('tbody').innerHTML = tableHtml;
            document.getElementById('winnerBadge').textContent = best.id + ' (' + best.rate + '%)';
            const live = sessions.slice(-15).reverse();
            document.getElementById('liveFeed').innerHTML = live.map(s => '<div class="feed-item"><span><span class="dot"></span> ' + (s.stepName || 'In√≠cio') + '</span><small style="color: var(--muted)">' + new Date(s.lastUpdate || s.enteredAt).toLocaleTimeString() + '</small></div>').join('');
            renderHistory(sessions);
        });

        function renderHistory(sessions) {
            const historyContainer = document.getElementById('historyAccordion'); const days = {};
            sessions.forEach(s => {
                const date = new Date(s.enteredAt).toLocaleDateString();
                if (!days[date]) days[date] = { total: 0, sales: 0, hours: new Array(24).fill(0) };
                days[date].total++; if (s.currentStep === 99) days[date].sales++;
                const h = new Date(s.enteredAt).getHours(); days[date].hours[h]++;
            });
            const sortedDays = Object.keys(days).sort((a,b) => new Date(b) - new Date(a)).slice(0, 7);
            historyContainer.innerHTML = sortedDays.map(day => {
                const d = days[day]; const rate = ((d.sales/d.total)*100).toFixed(1);
                return '<div class="accordion"><div class="accordion-header" onclick="this.parentElement.classList.toggle(\'active\')"><span>üìÖ ' + day + '</span><span>' + d.total + ' Visitas | ' + d.sales + ' Checkouts | <span style="color: var(--primary)">' + rate + '%</span> ‚ñæ</span></div><div class="accordion-content"><div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 5px; text-align: center;">' + d.hours.map((count, h) => '<div style="background: #1a1a1a; padding: 5px; border-radius: 4px;"><div style="font-size: 9px; color: var(--muted)">' + h + 'h</div><div style="font-weight: 800; font-size: 12px;">' + count + '</div></div>').join('') + '</div></div></div>';
            }).join('');
        }

        window.fixWinner = async () => {
            const snap = await get(ref(db, 'optimization/variants')); if (!snap.exists()) return;
            const variants = snap.val(); let bestIdx = 0; let bestRate = -1;
            [0,1,2,3,4].forEach(i => { const v = variants['cta_' + i] || {tests: 0, converted: 0}; const rate = v.tests > 0 ? v.converted / v.tests : 0; if (rate > bestRate) { bestRate = rate; bestIdx = i; } });
            await set(ref(db, 'optimization/winner'), { saudacao: bestIdx, resultado: bestIdx, cta: bestIdx });
            alert("Varia√ß√£o " + bestIdx + " fixada como campe√£!");
        };
        initCharts();
    </script>
</body>
</html>
